<?xml version="1.0" encoding="UTF-8"?>

<Server version="8">
    <Name>OvenMediaEngine</Name>
    <!-- Host type (origin/edge) -->
    <Type>origin</Type>
    <!-- Specify IP address to bind ("*" means all IPv4 IPs, "::" means all IPv6 IPs) -->
    <!-- Uncomment the line below to enable IPv6 -->
    <!-- <IP>::</IP> -->
    <IP>*</IP>
    <PrivacyProtection>false</PrivacyProtection>

    <!-- 
    To get the public IP address(mapped address of stun) of the local server. 
    This is useful when OME cannot obtain a public IP from an interface, such as AWS or docker
    environment. 
    If this is successful, you can use ${PublicIP} in your settings.
    -->
    <StunServer>stun.ovenmediaengine.com:13478</StunServer>

    <Modules>
        <!-- 
        Currently OME only supports h2 like all browsers do. Therefore, HTTP/2 only works on TLS ports.
        -->
        <HTTP2>
            <Enable>true</Enable>
        </HTTP2>

        <LLHLS>
            <Enable>true</Enable>
        </LLHLS>

        <!-- P2P works only in WebRTC and is experiment feature -->
        <P2P>
            <!-- disabled by default -->
            <Enable>false</Enable>
            <MaxClientPeersPerHostPeer>2</MaxClientPeersPerHostPeer>
        </P2P>
    </Modules>

    <!-- Settings for the ports to bind -->
    <Bind>
        <Managers>
            <API>
                <Port>${env:OME_API_PORT:8081}</Port>
                <WorkerCount>1</WorkerCount>
            </API>
        </Managers>
        <Providers>
            <RTMP>
                <Port>${env:OME_RTMP_PROV_PORT:1935}</Port>
                <WorkerCount>1</WorkerCount>
            </RTMP>
            <WebRTC>
                <Signalling>
                    <Port>${env:OME_WEBRTC_SIGNALLING_PORT:80}</Port>
                    <TLSPort>${env:OME_WEBRTC_SIGNALLING_TLS_PORT:443}</TLSPort>
                    <WorkerCount>1</WorkerCount>
                </Signalling>
                <IceCandidates>
                    <IceCandidate>
                        ${env:OME_HOST_IP:*}:${env:OME_WEBRTC_CANDIDATE_PORT:10000-10005/udp}</IceCandidate>
                    <TcpRelay>
                        ${env:OME_HOST_IP:*}:${env:OME_WEBRTC_TCP_RELAY_PORT:3478}</TcpRelay>
                    <TcpForce>true</TcpForce>
                    <TcpRelayWorkerCount>1</TcpRelayWorkerCount>
                </IceCandidates>
            </WebRTC>
        </Providers>
        <Publishers>
            <!-- The OVT is protocol for ORIGIN-EDGE -->
            <OVT>
                <Port>${env:OME_ORIGIN_PORT:9000}</Port>
                <WorkerCount>1</WorkerCount>
            </OVT>
            <WebRTC>
                <Signalling>
                    <Port>${env:OME_WEBRTC_SIGNALLING_PORT:80}</Port>
                    <TLSPort>${env:OME_WEBRTC_SIGNALLING_TLS_PORT:443}</TLSPort>
                    <WorkerCount>1</WorkerCount>
                </Signalling>
                <IceCandidates>
                    <IceCandidate>
                        ${env:OME_HOST_IP:*}:${env:OME_WEBRTC_CANDIDATE_PORT:10000-10005/udp}</IceCandidate>
                    <TcpRelay>
                        ${env:OME_HOST_IP:*}:${env:OME_WEBRTC_TCP_RELAY_PORT:3478}</TcpRelay>
                    <TcpForce>true</TcpForce>
                    <TcpRelayWorkerCount>1</TcpRelayWorkerCount>
                </IceCandidates>
            </WebRTC>
        </Publishers>
    </Bind>

    <Managers>
        <Host>
            <Names>
                <Name>*</Name>
            </Names>
            <!-- <TLS>
                    <CertPath>./cert.crt</CertPath>
                    <KeyPath>./cert.key</KeyPath>
                    <ChainCertPath>./cert.ca-bundle</ChainCertPath>
            </TLS> -->
        </Host>
        <API>
            <AccessToken>ome:default</AccessToken>
            <CrossDomains>
                <Url>*</Url>
            </CrossDomains>
        </API>
    </Managers>

    <VirtualHosts>
        <!-- You can use wildcard like this to include multiple XMLs -->
        <VirtualHost include="VHost*.xml" />
        <VirtualHost>
            <Name>default</Name>
            <!--Distribution
            is a value that can be used when grouping the same vhost distributed across multiple servers. This
            value is output to the events log, so you can use it to aggregate
            statistics. -->
            <Distribution>ovenmediaengine.com</Distribution>

            <!-- Settings for multi ip/domain and TLS -->
            <Host>
                <Names>
                    <Name>*</Name>
                </Names>
                <!-- <TLS>
                        <CertPath>./cert.crt</CertPath>
                        <KeyPath>./cert.key</KeyPath>
                        <ChainCertPath>./cert.ca-bundle</ChainCertPath>
                </TLS> -->
            </Host>

            <!-- Default CORS Settings -->
            <CrossDomains>
                <Url>*</Url>
            </CrossDomains>

            <!-- Settings for applications -->
            <Applications>
                <Application>
                    <Name>app</Name>
                    <!-- Application type (live/vod) -->
                    <Type>live</Type>
                    <OutputProfiles>
                        <!-- Common setting for decoders. Decodes is
                        optional. -->
                        <Decodes>
                            <!-- Number of threads for the decoder. -->
                            <ThreadCount>2</ThreadCount>
                            <!-- 
                            By default, OME decodes all video frames. 
                            With OnlyKeyframes, only keyframes are decoded, massively improving performance.
                            Thumbnails are generated only on keyframes, they may not generate at your requested fps!
                            -->
                            <OnlyKeyframes>false</OnlyKeyframes>
                        </Decodes>

                        <!-- Enable this configuration if you want to
                        hardware acceleration using GPU -->
                        <HWAccels>
                            <Decoder>
                                <Enable>false</Enable>
                                <!-- 
                                                Setting for Hardware Modules.
                                                 - xma :Xilinx Media Accelerator
                                                 - qsv :Intel Quick Sync Video
                                                 - nv : Nvidia Video Codec SDK
                                                 - nilogan: Netint VPU

                                                You can use multiple modules by separating them with commas.
                                                For example, if you want to use xma and nv, you can set it as follows.

                                                <Modules>[ModuleName]:[DeviceId],[ModuleName]:[DeviceId],...</Modules>
                                                <Modules>xma:0,nv:0</Modules>
                                            -->
                                <!-- <Modules>nv</Modules> -->
                            </Decoder>
                            <Encoder>
                                <Enable>false</Enable>
                                <!-- <Modules>nv</Modules> -->
                            </Encoder>
                        </HWAccels>

                        <OutputProfile>
                            <Name>abr_stream</Name>
                            <OutputStreamName>${OriginStreamName}</OutputStreamName>
                            <Playlist>
                                <Name>ABR</Name>
                                <FileName>abr</FileName>
                                <Options>
                                    <WebRtcAutoAbr>true</WebRtcAutoAbr>
                                </Options>
                                <Rendition>
                                    <Name>1080P</Name>
                                    <Video>video_1080</Video>
                                    <Audio>opus_audio</Audio>
                                </Rendition>
                                <Rendition>
                                    <Name>720P</Name>
                                    <Video>video_720</Video>
                                    <Audio>opus_audio</Audio>
                                </Rendition>
                                <Rendition>
                                    <Name>480P</Name>
                                    <Video>video_480</Video>
                                    <Audio>opus_audio</Audio>
                                </Rendition>
                            </Playlist>

                            <Playlist>
                                <Name>ABR2</Name>
                                <FileName>bypassabr</FileName>
                                <Options>
                                    <WebRtcAutoAbr>true</WebRtcAutoAbr>
                                </Options>
                                <Rendition>
                                    <Name>Bypass</Name>
                                    <Video>bypass_video</Video>
                                    <Audio>opus_audio</Audio>
                                </Rendition>
                                <Rendition>
                                    <Name>1080P</Name>
                                    <Video>video_1080</Video>
                                    <Audio>opus_audio</Audio>
                                </Rendition>
                                <Rendition>
                                    <Name>720P</Name>
                                    <Video>video_720</Video>
                                    <Audio>opus_audio</Audio>
                                </Rendition>
                                <Rendition>
                                    <Name>480P</Name>
                                    <Video>video_480</Video>
                                    <Audio>opus_audio</Audio>
                                </Rendition>
                            </Playlist>

                            <Playlist>
                                <Name>BYPASS</Name>
                                <FileName>bypass</FileName>
                                <Options>
                                    <WebRtcAutoAbr>true</WebRtcAutoAbr>
                                </Options>
                                <Rendition>
                                    <Name>Bypass</Name>
                                    <Video>bypass_video</Video>
                                    <Audio>opus_audio</Audio>
                                </Rendition>
                            </Playlist>

                            <Encodes>
                                <Audio>
                                    <Name>opus_audio</Name>
                                    <Codec>opus</Codec>
                                    <Bitrate>128000</Bitrate>
                                    <Samplerate>48000</Samplerate>
                                    <Channel>2</Channel>
                                    <BypassIfMatch>
                                        <Codec>eq</Codec>
                                    </BypassIfMatch>
                                </Audio>
                                <Video>
                                    <Name>bypass_video</Name>
                                    <Bypass>true</Bypass>
                                </Video>
                                <Video>
                                    <Name>video_1080</Name>
                                    <Codec>h264</Codec>
                                    <Bitrate>4096000</Bitrate>
                                    <Width>1920</Width>
                                    <Height>1080</Height>
                                    <Framerate>30</Framerate>
                                </Video>
                                <Video>
                                    <Name>video_720</Name>
                                    <Codec>h264</Codec>
                                    <Bitrate>2048000</Bitrate>
                                    <Width>1280</Width>
                                    <Height>720</Height>
                                    <Framerate>30</Framerate>
                                </Video>
                                <Video>
                                    <Name>video_480</Name>
                                    <Codec>h264</Codec>
                                    <Bitrate>1024000</Bitrate>
                                    <Width>854</Width>
                                    <Height>480</Height>
                                    <Framerate>30</Framerate>
                                </Video>
                            </Encodes>
                        </OutputProfile>
                    </OutputProfiles>
                    <Providers>
                        <WebRTC>
                            <Timeout>30000</Timeout>
                            <CrossDomains>
                                <Url>*</Url>
                            </CrossDomains>
                        </WebRTC>
                        <RTMP />
                    </Providers>
                    <Publishers>
                        <AppWorkerCount>1</AppWorkerCount>
                        <StreamWorkerCount>8</StreamWorkerCount>
                        <OVT />
                        <WebRTC>
                            <Timeout>30000</Timeout>
                            <Rtx>false</Rtx>
                            <Ulpfec>false</Ulpfec>
                            <JitterBuffer>false</JitterBuffer>
                            <CreateDefaultPlaylist>true</CreateDefaultPlaylist>
                        </WebRTC>
                    </Publishers>
                </Application>
            </Applications>
        </VirtualHost>
    </VirtualHosts>
</Server>